#!/bin/sh
#Find file in mounted or installed .pfs packages
#VERSION 3.6
. $(which pfs)

case "$1" in 
  "") echo "Usage: $(basename "$0") FILE"; exit 1;;
  "-"*[A-Za-z]*) echo "$(basename "$0"): invalid option -- '$(echo $1 | tr -d '-')'" >&2; exit 1;;
  *) findname="$1";;
esac

echo "         in pfs spec files:"
find "${PFSDIR}"  -mindepth 3 -maxdepth 3 -type f -name 'pfs.files' | while read listfiles; do   
cat "${listfiles}" | sed "s:^:"$(basename $(dirname $listfiles))" :" ; done | grep /${findname}$ | cut -f1 -d' ' | sort -uf
echo ''
#p=/mnt/live/memory/images/
p=$prefixmp

[ -d $p ] || exit 0
f="`basename "$1"`"
echo "         in mounted modules:"
list=$(find "$p" \( -type f -o -type l \) -name "$f" |sed 's#^'$p'## ; s/'$f'$//')
aufs-n --raw '$n $dname_source $bname_source' | while read a; do
	for b in $list ; do
		if [ "$(echo $a |awk '{print $NF}')" == "$(echo $b |awk -F/ '{print $1}' )" ]  ; then
		  echo $(echo -n $a |awk '{print $1 " " $2 "/" $3}' ) $(echo $b | sed "s:"$(echo $a |awk '{print $NF}')"::")
		fi
	done
done
 
exit 0
