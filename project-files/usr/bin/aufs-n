#!/bin/sh
#aufs layers list
#VERSION 3.6
. `which pfs`
header () {
echo "AUFS layers (top layer \"0\" covers all lower )"
printf %3s "N "; printf %-8s "AUFS" ; printf %-65s 'Module mount point';  printf %-5s "MP"; printf "Source\n\n"
}

listing () {
n=0
while true; do 
    a="$( cat /sys/fs/aufs/si_*/br$n 2>/dev/null    || break )"
    [ $a ] || break 
    aufs_perm=$(echo $a |awk -F= '{print $2}')
    a=$(echo $a |awk -F= '{print $1}')
    mp_perm=$( [ -w $a ] && echo rw || echo ro )
    loop=$(findmnt  $a -o SOURCE | tail -n1 ) ; [ $loop ] || loop=$(df $a |tail -n1 | awk '{print $1}')
    source=$(losetupb |grep "$loop " |awk '{print $NF}') ; [ $source ] || source=$loop
    if [ $human ] ; then 
      printf %3s "$n "; printf %-8s "$aufs_perm"; printf %-65s $a;  printf %-5s "$mp_perm";  printf "${source}\n"
    else
      echo "$n  $aufs_perm $a $mp_perm ${source}"
    fi
    n=$(expr $n + 1)
done
}

if [ ! $1 ] ;then 
	human=yes
	header
	listing
	exit
elif [ "$1" == "--raw" ] ; then
	listing
	exit
elif echo $1 |grep -q '^[[:digit:]]*$' ; then
	cat /sys/fs/aufs/si_*/br$1 |head -n1 |sed 's/=.*//'
else 
    help     
fi  
