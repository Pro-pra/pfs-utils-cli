#!/bin/sh
#aufs layers list
#VERSION 3.6
. `which pfs`
header () {
echo "AUFS layers (top layer \"0\" covers all lower )"
echo ""
printf %3s "N "; printf %-65s "Mount point " ; printf "AUFS perms\n"
printf %-68s "   Source " ;  printf  "MP perms\n\n"
}
usage () {
	echo -e "$(basename $0) util, detailed information about root aufs\n" 
	echo "Usage:" 
	echo "	$(basename $0)        - human readble format"
	echo "	$(basename $0) --raw  - format for pipes"
	echo "	$(basename $0) N      - returns mount point of layer \"N\" "
}

listing () {
n=0
while true; do 
    a="$( cat /sys/fs/aufs/si_*/br$n 2>/dev/null    || break )"
    [ $a ] || break 
    aufs_perm=$(echo $a |awk -F= '{print $2}')
    a=$(echo $a |awk -F= '{print $1}')
    mp_perm=$( [ -w $a ] && echo rw || echo ro )
    loop=$(findmnt  $a -o SOURCE | tail -n1 ) ; [ $loop ] || loop=$(df $a |tail -n1 | awk '{print $1}')
    source=$(losetupb |grep "$loop " |awk '{print $NF}') ; [ $source ] || source=$loop
    if [ $human ] ; then 
      printf %3s "$n "; 
      
      printf %-65s "$a " ; printf %b "${color_default}"
      [ "$aufs_perm" == "rw" ] && printf %b "${color_green}" ; 
      printf "$aufs_perm\n" ; printf %b "${color_default}"
      
      [ "$source" == "tmpfs" ] && printf %b "${color_blue}" ;
      echo "$source" |grep -q "^/dev/.*$"  && printf %b "${color_yellow}" ;
      
      printf %-68s "   ${source} " ;  printf %b "${color_default}"
      [ "$mp_perm" == "rw" ] && printf %b "${color_green}" ;
      printf  "$mp_perm\n" ; printf %b "${color_default}"
      echo ''
    else
      echo "$n  $aufs_perm $a $mp_perm ${source}"
    fi
    n=$(expr $n + 1)
done
}

if [ ! $1 ] ;then 
	human=yes
	header
	listing
	exit
elif [ "$1" == "--raw" ] ; then
	listing
	exit
elif echo $1 |grep -q '^[[:digit:]]*$' ; then
	cat /sys/fs/aufs/si_*/br$1 |head -n1 |sed 's/=.*//'
else 
    usage     
fi  
