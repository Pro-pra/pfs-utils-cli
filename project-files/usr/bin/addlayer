#!/bin/sh
## addlayer, DdShurick 16.02.2017, GPL v2.
#170221b sfs
usage () {
	if [ "$1" ]; then
		echo "$0: $1"
		exit 1
	fi
	echo "Usage: addlayer n x"
	echo "	Монтирование x в n временный слой AUFS"
	echo "	n: [0-9] номер слоя aufs, созданного mkaufs"
	echo "	x: squashfs, файл с внутренней ФС ext или каталог."
	exit 0
}

[ "$1" = "" -o "$1" = "-h" -o "$1" = "--help" -o "$2" = "" ] && usage
[ "`df "$2" |egrep '^aufs |^unionfs '`" ] && { echo "Ошибка!
    '$2' находится на разделе с aufs. 
    Переместите на раздел с другой файловой системой."
delaufs "$1" && echo "AUFS слой '$1' размонтирован." ; exit 1
}

[ "$(id -u)" = 0 ] || usage "Разрешено только root"
SYSMNT="$(cut -f2 -d/ /sys/fs/aufs/si_*/br0 | head -n1)"

case "$1" in
	0) AUFSMNT="/"; shift;;
	[1-9]) N=$1
		if [ $N -lt $(ls -d /sys/fs/aufs/si_* | wc -w) ]; then
			AUFSMNT="/$SYSMNT/aufs$N"
			shift
		else
			usage "aufs с таким № нет"
		fi
	;;
	*) AUFSMNT="/" ;;
esac

NEWLAYER="$(realpath "$1")" || usage "Файл не найден"
[ "$(grep aufs$N /proc/mounts)" ] || usage "aufs с таким № не существует"
MODNAME="$(basename "$NEWLAYER")"
NAME="$(echo $MODNAME | sed 's/\....$//')"

case $(file -b $NEWLAYER) in
	*directory) MODTYPE="dir" ;;
	Squashfs*4.0*|Linux*ext*)
#		if [ "$(grep "/$NAME squashfs " /proc/mounts)" ]; then #if the module is already mounted
#			NEWLAYER="$(grep "/$NAME=" /sys/fs/aufs/si_*/br[1-9]* | cut -f2 -d:| cut -f1 -d=)"
#		else
			mkdir -p "/$SYSMNT/bundles$N/$MODNAME"
			mount -o loop "$NEWLAYER" "/$SYSMNT/bundles$N/$MODNAME"
			NEWLAYER="/$SYSMNT/bundles$N/$MODNAME"
#		fi
	;;
	"") usage "Missing modulename" ;;
	*) usage "Invalid format $MODNAME" ;;
esac

mount -o remount,add:1:"$NEWLAYER" "$AUFSMNT" || usage "Ошибка монтирования"

[ "$AUFSMNT" = "/" ] || echo "aufs смонтирована в '$AUFSMNT', сохранение изменений '/$SYSMNT/changes$N'."
