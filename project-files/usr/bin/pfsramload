#!/bin/sh
#Copy to RAM & Mount SquashFS to AUFS, by «sfs» & Zay, GPL v3.
#VERSION 3.0
. $(which pfsfunc)
allow_only_root

for arg in "$@"
do
  case "${arg}" in
    "-u" | "--upper") mntmode="-u";;
    "-l" | "--lower") mntmode="-l";;
    "-n" | "--no-update") fupdate="-d";;
    "-r" | "--read-only") romode="-r";;
    "-h" | "--help") infile=""; break;;
    "-"*[A-Za-z]*) echo "$(basename "$0"): invalid option -- '$(echo ${arg} | tr -d '-')'" >&2; exit 1;;
    *) infile="${arg}";;
  esac
done
if [ "${infile}" = "" ]; then
  echo "Usage: $(basename "$0") [OPTIONS] FILE${IFS}${IFS}Options:"
  echo " -u, --upper    Copy file to RAM & Mount to upper layer (AUFS)."
  echo " -l, --lower    Copy file to RAM & Mount to lower layer (AUFS)."; exit
  echo " -r, --read-only Mount read-only"
  echo " -n, --no-update Do not check for update caches"
fi
if [ -f "${infile}" ]; then
  fsfile="$(realpath "${infile}")"
else
  echo "File \"${infile}\" not found!" >&2; exit 1
fi

fsname="$(basename "${fsfile}")"
mountpoint="${prefixmp}${fsname}"

mkdir -p ${copyramdir}
[ -d "${mountpoint}" ] && rmdir "${mountpoint}" 2>/dev/null
[ -d "${mountpoint}" ] && exitmsg "File \"${fsname}\" is mounted!" 2

freeram="$(checkramfreeb)"
filesize="`expr $(du -k "${fsfile}" | cut -f 1)`"
minram="$(expr ${filesize} + ${TMPFSLIMIT})"
[ ${minram} -gt ${freeram} ] && exitmsg "Not enouth free RAM space" 3

[ "$(stat  --format=%T -f $copyramdir )" != "tmpfs" ] && mountb -t tmpfs tmpfs "${copyramdir}"
if [ -f "${copyramdir}/${fsname}" ] ;then 
	pfsunload ${fsname} 
	rm -f "${copyramdir}/${fsname}"
	exitmsg "File already in ram and mounted" $?
fi
#echo "\"${fsname}\" copying to RAM..."
cp -afL "${fsfile}" "${copyramdir}/"
exitmsg "Can't copy to ram" $?
pfsload ${mntmode} ${fupdate} ${romode} "${copyramdir}/${fsname}"
if [ $? -ne 0 ]; then
  rm -f "${copyramdir}/${fsname}" 2>/dev/null
  exitmsg "ERROR pfsload" 4
fi

