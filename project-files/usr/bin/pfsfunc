#!/bin/sh
#library for pfs-utils, GPL v3.
#Author: Zay, pappyrus.org
#Author: DdShurick, pappyrus.org
#Author: Sfs, pappyrus.org
#Author: Betcher, magos-linux.ru
#VERSION 3.1
PFSDIR=/etc/packages
TMPFSLIMIT=100000

copyramdir="/tmp/.mountRAM"
prefixmp="/mnt/."
changesDir="/mnt/live/memory/changes/"
if [ -f /etc/initvars ] ; then
        . /etc/initvars
        [ "$SYSMNT" ] || SYSMNT=$(cut -f2 -d/ /sys/fs/aufs/si_*/br0 |head -n1)
        copyramdir=${SYSMNT}/copy2ram/
        prefixmp=${SYSMNT}/bundles/
        changesDir=${SYSMNT}/changes/
fi

compression="xz -b 512K"
compression_fast="lz4 -b 512K"
if echo $compression |grep -q xz; then
	if uname -m | grep -q -e "86" -e "32" -e "64" ;then
	compression="$compression -Xbcj x86" 
	else 
	compression="$compression -Xbcj x86,arm"
	fi
fi

usage () {
	echo -e "$(basename $0) is a library for pfs-utils \n" 
	echo "Usage:" 
	echo "	$(basename $0) <function> <pars>"
	echo "		OR"
	echo -e "	. $(realpath $0) ;  <function> <pars> \n"
	echo "functions list:"
	echo "$(cat $0 |grep '^.*\ *().*{\ *$' |sed 's/().*{//')"
	exit 1
}

color_red='\033[0;31m'
color_green='\033[0;32m'
color_default='\033[0m'

exitmsg () {
	if [ "$2" -ne 0 ] ; then
	echo -ne "$color_red" ; echo "$1" ; echo -ne "$color_default\n"
	exit $2
	fi
} 

allow_only_root() {
    if [ "0$UID" -ne 0 ]; then
        exitmsg "Only root can run $0" -1
    fi
}

mklist () {
source_dir="$(realpath "$1")"
[ "$2" ] && dest_dir="$(realpath "$2")" || dest_dir="$source_dir"
pack_name="$(basename "$1")"
#[ "$(pwd)" != "/" ] && find "$source_dir/${PFSDIR}/mount/" -mindepth 1 -maxdepth 1 -type d ! -name "${pack_name}" -exec rm -rf "{}" \;
[ "$(pwd)" != "/" ] && find "${source_dir}${PFSDIR}/mount/" -mindepth 1 -maxdepth 1  -exec rm -rf "{}" \; 2>/dev/null
mkdir -p "${dest_dir}${PFSDIR}/mount/${pack_name}" &&
echo 'name="'$pack_name'"' > "${dest_dir}${PFSDIR}/mount/${pack_name}/pfs.specs" &&
find "${source_dir}" ! -type d | sed "s:$source_dir::" > "${dest_dir}${PFSDIR}/mount/${pack_name}/pfs.files" &&
find "${source_dir}"  -type d -empty | sed "s:$source_dir::" > "${dest_dir}${PFSDIR}/mount/${pack_name}/pfs.dirs.empty" &&
[ -s "${dest_dir}${PFSDIR}/mount/${pack_name}/pfs.dirs.empty" ] || rm "${dest_dir}${PFSDIR}/mount/${pack_name}/pfs.dirs.empty" || 
exitmsg "mklist error" -1
}

checkramfreeb () {
	local free  
if [[ -x $(which checkramfree) ]] ; then
	echo $(checkramfree) 
else
   free=$(expr $(df $copyramdir -B 1024 |grep tmpfs |awk '{print $4}') -  $TMPFSLIMIT)
   echo $free
fi 2>/dev/null
}

checksfsxzb () {
grep squashfs /proc/filesystems || return 1
grep aufs /proc/filesystems     || return 1
#check xz
kerneluname="$(uname -r)"
kernel1ver="$(echo -n "${kerneluname}" | cut -f 1 -d '.' | cut -f 1 -d '-')"
if [ ${kernel1ver} -lt 3 ];then
  kernel2ver="$(echo -n "${kerneluname}" | cut -f 2 -d '.' | cut -f 1 -d '-')"
  if [ ${kernel2ver} -lt 6 ];then
    return 1
  else
    kernel3ver="$(echo -n "${kerneluname}" | cut -f 3 -d '.' | cut -f 1 -d '-')"
    if [ ${kernel3ver} -lt 38 ]; then
      return 1
    fi
  fi
fi
return 0
}

disktypeb () {
if disktype $1 2>/dev/null ; then 
	return 0
else
	ftest=$(file $1)
	if $(echo $ftest |egrep -qi cannot.*open) ; then
		echo $ftest
		return 1
	elif $(echo $ftest |egrep -qi block.*special) ;then
		echo $(blkid -s TYPE $1)
		return 0
	else 
		echo $ftest
		return 0
	fi
fi
}

fs_type () {
diskinfo="$(disktypeb "$1" 2>/dev/null)"
if echo "${diskinfo}" | grep -qi -F "Ext2" ;then
  echo 'ext2'
elif echo "${diskinfo}" | grep -qi -F "Ext3" ;then
  echo 'ext3'
elif echo "${diskinfo}" | grep -qi -F "Ext4" ;then
  echo 'ext4'
elif echo "${diskinfo}" | grep -qi -F "squashfs" ;then
  echo 'squashfs'
elif echo "${diskinfo}" | grep  -qi "ISO.*9660" ;then
  echo 'iso9660'
fi
}


lddcheck () {
	local rootdir alllibs
[ "${1}" != "" ] && rootdir="${1}" || rootdir="./"
if [ ! -d "${rootdir}" ]; then
  echo "Directory \"${rootdir}\" not found!" >&2; exit 1
fi
alllibs="$(find "${rootdir}" ! -type d -name "*.so*")" 
find "${rootdir}" -type f -executable | while read chfile; do [ "$(file --brief "${chfile}" | grep -E "LSB executable|shared object")" ] && ldd "${chfile}" 2>/dev/null; done | grep -E '\.so$|\.so\.[0-9]' | sed 's/(..........)/()/' | sort -u | sed 's/[ \t]*//;s/.* =>  ()//;s/ => .*$//;s/ ()//' | while read exlib; do echo "${alllibs}" | grep -q -F "${exlib}" || echo "${exlib}"; done | grep -v -F "linux-gate.so" | sort -uf
return 0
}

losetupb () {
	if [ -x "$(which losetup-FULL)" ]; then
  losetup-FULL $@
elif   [ -x "$(which losetup)" ] ; then
	losetup $@ || exit 1
fi 2>/dev/null
return $?
}

mountb () {
if [ -x "$(which busybox)" ]; then
  if busybox --list | grep -q -F mount; then
    busybox mount $@
  else
    [ -x "$(which mount)" ] && mount $@ || return 1
  fi
else
  [ -x "$(which mount)" ] && mount $@ || return 1
fi
return $?
}

umountb () {
if [ -x "$(which busybox)" ]; then
  if busybox --list | grep -q -F umount; then
    busybox umount $@
  else
    [ -x "$(which umount)" ] && umount $@ || return 1
  fi
else
  [ -x "$(which umount)" ] && umount $@ || return 1
fi
return $?
}

if [ "$(basename $0)" == "pfsfunc" ] ;then
[ $1 ] || usage
command="$1" 
shift
$command $@
exitmsg "$command  ERROR!!!" "$?"
fi 

