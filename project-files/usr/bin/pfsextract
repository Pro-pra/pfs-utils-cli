#!/bin/sh
#VERSION 3.3
. /usr/bin/pfsfunc

HLP(){
[ "`echo $LANG| egrep '^ru_RU'`" ] || return
echo "\
pfsextract извлекает отдельные модули из составных модулей.pfs.
Использование:

    pfsextract /file.pfs [параметры] - создать каталог «/file» с отдельными модулями.pfs из «/file.pfs»
    pfsextract -d /file.pfs [параметры] - создать каталог «/file» с отдельными каталогами, в каждый из которых распакованы отдельные модули из «/file.pfs»
    pfsextract /file.pfs /catalog [параметры] - создать в каталоге «/catalog» отдельные модули.pfs из «/file.pfs». «/catalog» должен быть пустым.
    pfsextract /file.pfs /catalog -p pack_1 pack_2 [параметры] - создать в каталоге «/catalog» отдельные файлы .pfs только из модулей «pack_1» и «pack_2», если модули с такими названиями содержатся в файле «/file.pfs» (использование «-p pack_1 pack_2» допустимо и без указания «/catalog»).

Параметры (ключи):

    -no-progress - не показывать строку прогресса.
    -f  - быстрая компрессия (размер .pfs больше, но создается быстрее).
" >&2 ;exit 1
}

[ "$1" = "-d" ] && d=1 && shift
[ "$1" ] || HLP
allow_only_root

#check kernel
checksfsxzb >/dev/null 2>&1
exitmsg "Kernel is not support squashfs/aufs" $?

wh="-regex -e ".wh..wh.""

argslist="$@"
if  echo $argslist |grep -q "\-*comp .*" ; then
	compression="$(echo $@ |sed 's/^.*\-*comp//')"
	argslist="$(echo $@ |sed 's/\-*comp.*$//')"
fi

#get opts
sourcelist=""
for arg in $argslist
do
  case "${arg}" in
    "-o" | "--out-file") onuserout="on";;
    "-d" | "--nopfs") d=yes ;;
    "-h" | "--help")  HLP ;exit 1;;
    "-q" | "--quiet" ) devnull='>/dev/null' ;;
    "-no-progress" | "--no-progress") noprogress="-no-progress";;
    "-processors" | "--processors" ) numproc="on";;
    "-f" | "--fast"  ) [ "$compression_fast" ] && compression="$compression_fast" || compression="gzip";;
    "-"*[A-Za-z]*) echo "$(basename "$0"): invalid option -- '$(echo ${arg} | tr -d '-')'" >&2; HLP; exit 1;;
    *) if [ "${onuserout}" = "on" ]; then dir="${arg}"
        elif [ "${numproc}" = "on" ]; then useproc="-processors ${arg}"
        else sourcelist="${sourcelist} ${arg}"; fi
        onuserout="off";  numproc="off";;
  esac
done

for item in $sourcelist ; do
	if [ "$(fs_type $item)" == "squashfs" ] ; then
	pfs=$item
	sourcelist=$(echo "$sourcelist" |sed "s/$item//")
	break
	fi 
done
[ $pfs ] || exitmsg "There is no source pfs module" 2 
[ $dir ] || dir="./"

echo out dir: $dir
echo pfs file : $pfs
echo list of packages : $sourcelist
echo compression: $compression
echo devnull: $devnull


echo $sourcelist  |grep -q [[:alnum:]] || unset sourcelist

mkdir -p "$dir"

#no component-pfs or simple squashfs
if [ "$(unsquashfs -l ${pfs} |grep ${PFSDIR}/mount |egrep '.files$' |wc -l)" -lt 2 ];then
     [ "$sourcelist" ] && exitmsg "File '${pfs}' is not component-pfs.  Can't extract packages: $sourcelist" 1
    dir=$dir/$(basename "${pfs%.*}") 
    eval unsquashfs -d "${dir}" "${pfs}" $noprogress $useproc "$devnull"  && exit 0
	exitmsg "unsquashfs error" $?
fi
pfsinfo "$pfs" |while read m ;do
    if  [ "$sourcelist" ] 	;then 
		echo $sourcelist |grep -q "$m" || continue
    fi
    echo  package: $m    -- processing...
    n="$(mkaufs || exitmsg "mkaufs error" 2)"
	nn="$(echo "$n" | sed -n 's/^.*\([0-9]\)$/\1/p')"
	[ -d "$n" ] || exitmsg "error mounting aufs" 3
    eval addlayer "$nn" "$pfs" "$devnull" || exitmsg "can't insert layer to aufs $nn" 5
    cat "$SYSMNT/aufs${nn}/etc/packages/mount/${m}/pfs.files" | while read F; do 
	touch "$SYSMNT/aufs$nn$F"
    done

    emp="$SYSMNT/aufs$nn/etc/packages/mount/$m/pfs.dirs.empty"
    [ -f "$emp" ] && cat "$emp" | while read F; do 
	touch "$SYSMNT/aufs$nn$F"
    done

    mklist "$SYSMNT/changes$nn" "$SYSMNT/aufs$nn" "$m" 
    if [ "$d" ];then	
	mkdir -p "$dir/$m" && cp -au "$SYSMNT/changes$nn"/* "$dir/$m"
    else
	mksqmod "$SYSMNT/changes$nn" "$dir/$m.pfs"
    fi
    delaufs $nn
done 
